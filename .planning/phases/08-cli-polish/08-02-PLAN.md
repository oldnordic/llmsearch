---
phase: 08-cli-polish
plan: 02
type: execute
depends_on: []
files_modified: [src/main.rs]
autonomous: true
---

<objective>
Implement --json flag logic for structured JSON output.

Purpose: Route JSON to stdout and suppress debug output when --json flag is set.
Output: Clean JSON output on stdout when --json is enabled
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/cli.rs
@src/main.rs

# Phase 6-03 provides JSON serialization:
@.planning/phases/06-json-output/06-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route JSON to stdout when --json is enabled</name>
  <files>src/main.rs</files>
  <action>Update main() to route JSON based on --json flag:

Current code outputs JSON to stderr with debug messages. Modify to:
1. When args.json is true: print compact JSON to stdout, suppress all eprintln! debug output
2. When args.json is false: keep current behavior (debug to stderr, JSON to stderr for now)

Find the JSON output section (around line 254-275) and replace:

```rust
// Phase 6: JSON output
let output = SearchOutput {
    execution_id: execution_id.clone(),
    pattern: args.pattern.clone(),
    matches: limited_matches.clone(),
    match_count: limited_matches.len(),
};

// Output routing based on --json flag
if args.json {
    // JSON mode: compact output to stdout, no debug messages
    match serde_json::to_string(&output) {
        Ok(json) => {
            println!(\"{}\", json);
        }
        Err(e) => {
            eprintln!(\"Error serializing to JSON: {}\", e);
            std::process::exit(1);
        }
    }
} else {
    // Debug mode: pretty JSON to stderr with execution details
    eprintln!();
    eprintln!(\"JSON Output:\");
    match serde_json::to_string_pretty(&output) {
        Ok(json) => {
            eprintln!(\"{}\", json);
        }
        Err(e) => {
            eprintln!(\"Error serializing to JSON: {}\", e);
            std::process::exit(1);
        }
    }
}
```

Key implementation notes:
- Use `serde_json::to_string()` for compact JSON (not to_string_pretty)
- Use `println!` for stdout (JSON mode) vs `eprintln!` for stderr (debug mode)
- JSON mode: no debug output at all (clean for piping/parsing)
- Debug mode: keeps all existing eprintln! statements
</action>
  <verify>`cargo build` succeeds</verify>
  <done>JSON routes to stdout when --json is set, stderr otherwise</done>
</task>

<task type="auto">
  <name>Task 2: Suppress debug output in JSON mode</name>
  <files>src/main.rs</files>
  <action>Conditionally suppress debug eprintln! statements when --json is enabled.

Wrap all debug output in `if !args.json` conditions. The following lines need conditional output:

1. Execution ID message (line ~212)
2. Files found count (line ~216)
3. Pattern compiled message (line ~227)
4. Matches found count (line ~231)
5. Sorted message (line ~236)
6. Limit message (lines ~242-243)
7. Match debug loop (lines ~246-252)
8. UTF-8 handling messages (lines ~285-287)
9. Scaffolding complete messages (lines ~290-294)

Example pattern for each debug statement:
```rust
// Before:
eprintln!(\"Execution ID: {}\", execution_id);

// After:
if !args.json {
    eprintln!(\"Execution ID: {}\", execution_id);
}
```

For cleaner code, consider wrapping multiple related debug lines:
```rust
if !args.json {
    eprintln!(\"Execution ID: {}\", execution_id);
    eprintln!(\"Found {} files\", files.len());
    eprintln!(\"Pattern compiled successfully\");
    // ... more debug output
}
```

Important: Keep error messages (eprintln! + exit(1)) unconditional - errors should always be visible.
</action>
  <verify>`cargo build` succeeds</verify>
  <done>Debug output suppressed when --json is enabled, errors always shown</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds
- [ ] `llmsearch -p 'test' --json` outputs only JSON to stdout
- [ ] `llmsearch -p 'test'` (no --json) shows debug output
- [ ] JSON output is compact (not pretty-printed)
- [ ] Errors still go to stderr in both modes
- [ ] Can pipe output: `llmsearch -p 'test' --json | jq .`
</verification>

<success_criteria>

- --json flag routes JSON to stdout
- Compact JSON format (not pretty-printed)
- All debug output suppressed in JSON mode
- Error messages still shown in both modes
- Ready for error handling improvements in 08-03
  </success_criteria>

<output>
After completion, create `.planning/phases/08-cli-polish/08-02-SUMMARY.md`
</output>
