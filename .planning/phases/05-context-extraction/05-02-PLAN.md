---
phase: 05-context-extraction
plan: 02
type: execute
depends_on: ["05-01"]
files_modified: [src/main.rs]
autonomous: true
---

<objective>
Extract context after each match.

Purpose: Add a `context_after` field to Match containing the text immediately after the match. This completes the context extraction providing both sides of the match.
Output: Match struct with context_after field populated
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 5-01 provides context_before:
@.planning/phases/05-context-extraction/05-01-SUMMARY.md

# Current state:
@src/main.rs - Match struct has context_before, needs context_after
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context_after field and extraction</name>
  <files>src/main.rs</files>
  <action>Add context_after extraction to Match struct and search_files:

1. Update Match struct (add context_after):
```rust
struct Match {
    file: String,
    byte_start: usize,
    byte_end: usize,
    matched_text: String,
    line_number: usize,
    column_number: usize,
    context_before: String,
    context_after: String,   // NEW
}
```

2. Update search_files to extract context after match:
```rust
                    // Extract context before match (up to 100 chars or line start)
                    let context_start = line_start_byte.max(byte_start.saturating_sub(100));
                    let context_before = content[context_start..byte_start].to_string();

                    // Extract context after match (up to 100 chars or line end)
                    let line_end = content[byte_start..].find('\n').unwrap_or(content.len() - byte_start) + byte_start;
                    let context_end = line_end.min(byte_end + 100);
                    let context_after = content[byte_end..context_end.min(content.len())].to_string();
```

Wait - there's a bug in that logic. Let me fix it:

```rust
                    // Extract context before match (up to 100 chars or line start)
                    let context_start = line_start_byte.max(byte_start.saturating_sub(100));
                    let context_before = content[context_start..byte_start].to_string();

                    // Extract context after match (up to 100 chars or line end)
                    let remaining_line = &content[byte_end..];
                    let line_end_offset = remaining_line.find('\n').unwrap_or(remaining_line.len());
                    let context_end = byte_end + line_end_offset.min(100);
                    let context_after = content[byte_end..context_end.min(content.len())].to_string();

                    matches.push(Match {
                        file: file_path.clone(),
                        byte_start,
                        byte_end,
                        matched_text: mat.as_str().to_string(),
                        line_number: line_num,
                        column_number: col_num,
                        context_before,
                        context_after,
                    });
```

Key implementation notes:
- Context limited to 100 characters after match OR newline (whichever is closer)
- Uses find('\n') to locate end of current line
- Slices from byte_end to context_end for after-context
- min(content.len()) prevents out-of-bounds at end of file
- Keeps context on single line (doesn't go to next line)
</action>
  <verify>`cargo build` succeeds</verify>
  <done>context_after field populated with text after match</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds
- [ ] context_after field added to Match struct
- [ ] Context extracted up to 100 chars after match
- [ ] Context stops at newline (doesn't include next line)
- [ ] No overflow at end of file
</verification>

<success_criteria>

- context_after field captures text immediately after match
- Limited to 100 characters or line boundary
- Safe handling of matches at end of file/line
- Both context_before and context_after now populated
  </success_criteria>

<output>
After completion, create `.planning/phases/05-context-extraction/05-02-SUMMARY.md`
</output>
