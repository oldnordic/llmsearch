---
phase: 09-testing-validation
plan: 02
type: execute
depends_on: []
files_modified: [tests/cli.rs]
autonomous: true
---

<objective>
Create integration tests for CLI end-to-end behavior.

Purpose: Test the full CLI workflow from command invocation to JSON output.
Output: New tests/cli.rs integration test file
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/main.rs
@src/cli.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test file structure</name>
  <files>tests/cli.rs</files>
  <action>Create tests/cli.rs for integration tests:

```rust
use assert_cmd::Command;

#[test]
fn test_cli_search_returns_json() {
    // Test that basic search returns valid JSON
    Command::cargo_bin("llmsearch")
        .arg("-p")
        .arg("llmsearch")
        .arg("--json")
        .assert()
        .success()
        .stdout(predicates::str::is_json());
}

#[test]
fn test_cli_with_nonexistent_directory() {
    Command::cargo_bin("llmsearch")
        .arg("-r")
        .arg("/nonexistent/path/xyz123")
        .arg("-p")
        .arg("test")
        .assert()
        .failure()
        .stderr(predicates::str::contains("does not exist"));
}

#[test]
fn test_cli_with_empty_pattern() {
    Command::cargo_bin("llmsearch")
        .arg("-p")
        .arg("")
        .assert()
        .failure()
        .stderr(predicates::str::contains("cannot be empty"));
}

#[test]
fn test_cli_with_limit_zero() {
    Command::cargo_bin("llmsearch")
        .arg("-p")
        .arg("test")
        .arg("-l")
        .arg("0")
        .assert()
        .failure()
        .stderr(predicates::str::contains("must be at least 1"));
}

#[test]
fn test_cli_no_matches_returns_empty_json() {
    // Create a temp directory with a file
    let temp_dir = std::env::temp_dir();
    let test_file = temp_dir.join("no_match_test.txt");
    std::fs::write(&test_file, "no matches here").unwrap();

    Command::cargo_bin("llmsearch")
        .arg("-r")
        .arg(temp_dir.to_str().unwrap())
        .arg("-p")
        .arg("unlikelypatternxyz123")
        .arg("--json")
        .assert()
        .success()
        .stdout(predicates::str::is_json())
        .stdout(predicates::str::contains(r#""match_count":0"#));

    std::fs::remove_file(&test_file).unwrap();
}
```

This requires adding `assert_cmd` dependency to dev-dependencies.
</action>
  <verify>After adding dependency and creating tests, `cargo test` passes all CLI tests</verify>
  <done>Integration tests file created with basic CLI workflow tests</done>
</task>

<task type="auto">
  <name>Task 2: Add assert_cmd dependency to Cargo.toml</name>
  <files>Cargo.toml</files>
  <action>Add assert_cmd to dev-dependencies in Cargo.toml:

```toml
[dev-dependencies]
assert_cmd = "2.0"
```

This provides:
- `Command::cargo_bin()` - finds the built binary
- `.assert()` - fluent assertions for exit status
- `.success()` / `.failure()` - exit code checks
- `.stdout()` / `.stderr()` - output predicates
- `predicates::str::is_json()` - JSON validation predicate
</action>
  <verify>`cargo test` compiles and runs integration tests</verify>
  <done>assert_cmd dependency added for CLI testing</done>
</task>

<task type="auto">
  <name>Task 3: Add glob filtering integration test</name>
  <files>tests/cli.rs</files>
  <action>Add test for glob filtering in integration tests:

```rust
#[test]
fn test_cli_glob_filters_results() {
    let temp_dir = std::env::temp_dir();

    // Create test files
    let rust_file = temp_dir.join("test.rs");
    let txt_file = temp_dir.join("test.txt");
    std::fs::write(&rust_file, "fn main() {}").unwrap();
    std::fs::write(&txt_file, "some text").unwrap();

    let json_output = Command::cargo_bin("llmsearch")
        .arg("-r")
        .arg(temp_dir.to_str().unwrap())
        .arg("-p")
        .arg("main")
        .arg("-g")
        .arg("*.rs")
        .arg("--json")
        .output()
        .unwrap()
        .stdout;

    // Parse JSON and verify only .rs file found
    let output: serde_json::Value = serde_json::from_str(&json_output).unwrap();
    let matches = &output["matches"];

    assert_eq!(matches.as_array().unwrap().len(), 1);
    let file_path = matches[0]["file"].as_str().unwrap();
    assert!(file_path.ends_with("test.rs"));

    // Cleanup
    std::fs::remove_file(&rust_file).unwrap();
    std::fs::remove_file(&txt_file).unwrap();
}
```

This test verifies the full CLI workflow with glob filtering produces correct results.
</action>
  <verify>`cargo test test_cli_glob_filters_results` passes</verify>
  <done>Glob filtering integration test added</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `assert_cmd` added to Cargo.toml
- [ ] `cargo test` compiles integration tests
- [ ] test_cli_search_returns_json passes
- [ ] test_cli_with_nonexistent_directory fails correctly
- [ ] test_cli_with_empty_pattern fails correctly
- [ ] test_cli_no_matches_returns_empty_json passes
- [ ] test_cli_glob_filters_results passes
</verification>

<success_criteria>

- Integration tests created in tests/cli.rs
- assert_cmd dependency added
- Basic CLI workflows tested
- Error cases tested
- Glob filtering tested end-to-end
- Ready for determinism tests in 09-03
  </success_criteria>

<output>
After completion, create `.planning/phases/09-testing-validation/09-02-SUMMARY.md`
</output>
