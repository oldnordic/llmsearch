---
phase: 02-file-walking
plan: 02
type: execute
depends_on: ["02-01"]
files_modified: [src/main.rs]
autonomous: true
---

<objective>
Implement glob pattern filtering for file selection.

Purpose: Allow users to filter files by glob patterns (e.g., "*.rs", "*.ts"). This narrows the search scope to relevant file types.
Output: File walker that filters by glob patterns from CLI args
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2-01 provides:
@.planning/phases/02-file-walking/02-01-SUMMARY.md

# Current state:
@src/main.rs - walk_files function exists but glob filtering is placeholder
@src/cli.rs - CLI has --glob flag (Vec<String>)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement glob filtering in walk_files</name>
  <files>src/main.rs</files>
  <action>Update the `walk_files` function to filter by glob patterns:

1. Add glob matching support using ignore crate's `Match` trait:
```rust
use ignore::gitignore::{Gitignore, GitignoreBuilder};
use ignore::WalkBuilder;
```

2. Rewrite walk_files to use WalkBuilder with glob filters:
```rust
fn walk_files(root: &str, globs: &[String]) -> Vec<String> {
    let mut walker = WalkBuilder::new(root);
    walker.hidden(false); // Don't skip hidden files by default
    walker.git_ignore(true); // Use .gitignore
    walker.parents(true); // Respect parent .gitignore files

    // Build custom ignore from glob patterns
    let mut ignore_builder = GitignoreBuilder::new(root);

    if !globs.is_empty() {
        // User provided globs - treat as positive matches
        // We'll filter after collection since ignore crate treats
        // patterns as exclusions by default
    }

    let mut files = Vec::new();

    for result in walker.build() {
        match result {
            Ok(entry) => {
                if let Some(path) = entry.path().to_str() {
                    // Only include files, not directories
                    if !entry.file_type().map_or(false, |ft| ft.is_file()) {
                        continue;
                    }

                    // Apply glob filtering if patterns provided
                    if !globs.is_empty() {
                        let filename = entry.file_name().to_string_lossy();
                        let matches: bool = globs.iter().any(|g| {
                            // Simple glob matching - check if filename matches pattern
                            // Convert "*.rs" style glob to a simple check
                            if g.starts_with("*.") {
                                let ext = &g[2..];
                                filename.ends_with(ext)
                            } else if g.contains('*') {
                                // Simple wildcard match
                                let pattern = g.replace(".", "\\.").replace("*", ".*");
                                if let Ok(re) = regex::Regex::new(&pattern) {
                                    re.is_match(&filename)
                                } else {
                                    false
                                }
                            } else {
                                // Exact match
                                filename == *g
                            }
                        });

                        if !matches {
                            continue; // Skip files not matching any glob
                        }
                    }

                    files.push(path.to_string());
                }
            }
            Err(err) => {
                eprintln!("Warning: {}", err);
            }
        }
    }

    files
}
```

Key implementation notes:
- Use WalkBuilder for more control over walk behavior
- Glob patterns are positive filters (include matching files)
- Support patterns like "*.rs", "*.ts", or specific filenames
- Handle glob parsing gracefully - if pattern is invalid, skip it rather than crash
- Keep it simple for now - full glob syntax can be enhanced later if needed
</action>
  <verify>`cargo build` succeeds</verify>
  <done>`cargo run -- --glob "*.rs" --root .` only returns .rs files</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds
- [ ] `cargo run -- --glob "*.rs"` filters to only .rs files
- [ ] `cargo run -- --glob "*.rs" --glob "*.toml"` includes both types
- [ ] `cargo run --` with no --glob returns all files
- [ ] Invalid glob patterns don't crash the program
</verification>

<success_criteria>

- Glob patterns from CLI filter file list correctly
- Multiple glob patterns can be specified
- No glob patterns = all files included
- Invalid patterns handled gracefully
  </success_criteria>

<output>
After completion, create `.planning/phases/02-file-walking/02-02-SUMMARY.md`
</output>
